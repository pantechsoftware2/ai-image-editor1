â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  MVP LOOP ARCHITECTURE & FEATURE DOCUMENTATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

COMPLETE FLOW: URL â†’ Brand â†’ Prompt â†’ Image + Text â†’ Export

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FEATURE 1: SMART IMAGE SELECTION (The Merge)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Goal: Clicking an image automatically adds it to the canvas as background.

File: src/components/canvas.tsx - handleImageSelect()

How it works:
1. User clicks image in modal
2. handleImageSelect() called with selected image
3. Canvas context obtained (fabricCanvasRef)
4. Image loaded from URL or base64
5. Image scaled to 1080x1350 (full canvas)
6. Added with zIndex=0 (background layer)
7. generateAndAddHeadline() called immediately
8. Modal closes after 500ms

Code Path:
  Image Grid â†’ handleSelect(image)
    â†“
  Canvas component â†’ handleImageSelect(image)
    â†“
  Create fabric Image
    â†“
  Scale to 1080x1350
    â†“
  Add to canvas (zIndex=0)
    â†“
  Call generateAndAddHeadline()
    â†“
  Modal closes

Result: Full-canvas background image ready for text overlay

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FEATURE 2: AUTO-GENERATED HEADLINES (The Smart Overlay)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Goal: Automatically inject headlines generated by Gemini onto canvas
      using the user's brand font and colors.

Files: 
  - src/components/canvas.tsx - generateAndAddHeadline()
  - src/app/api/generateHeadline/route.ts - Gemini headline generation

How it works:
1. Image selected and loaded to canvas
2. generateAndAddHeadline() checks if prompt exists
3. Calls /api/generateHeadline with subject (prompt text)
4. API sends to Gemini with prompt engineering
5. Gemini returns 5-word marketing headline
6. Response parsed and cleaned (remove quotes, take first line)
7. Textbox created with:
   - Headline text from Gemini
   - Brand primary color (from brandData)
   - Brand font (brandData.fonts[0] or Arial fallback)
   - Centered alignment
   - Large font (48px) with bold weight
   - Black stroke for visibility over images
8. Textbox added to canvas
9. User can double-click to edit text anytime

Gemini Prompt:
  "Generate a single, short marketing headline (5 words max) 
   for a design image about "{subject}". 
   Be creative and punchy. 
   Return ONLY the headline text, nothing else."

Examples:
  Subject "coffee" â†’ Headline "Brew Perfection Daily"
  Subject "pizza" â†’ Headline "Slice Heaven Awaits You"
  Subject "sunset" â†’ Headline "Golden Hour Magic"

Code Path:
  Image Selected
    â†“
  generateAndAddHeadline() 
    â†“
  fetch /api/generateHeadline
    â†“
  Gemini generates prompt
    â†“
  "Create a headline about coffee..."
    â†“
  Gemini returns: "Brew Perfection Daily"
    â†“
  Parse response (clean quotes)
    â†“
  Create Textbox with brand styling
    â†“
  Add to canvas at top
    â†“
  User sees text overlaid on image

Result: Complete design with image + auto-generated headline

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FEATURE 3: AI TEXT EFFECTS MODE (Text Baking)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Goal: Enable "Text Baking" for users who want cool AI text effects.
      Renders text directly IN the image (non-editable).

UI Toggle: "Use AI Text Effects?" checkbox in Tools section

How it works:
1. User enters prompt (e.g., "coffee")
2. User toggles ON: "Use AI Text Effects?"
3. User clicks "ğŸ¨ Generate Image"
4. Canvas component sends to API:
   - useAIText: true
   - aiTextContent: "coffee" (the prompt text)
5. /api/generateImage checks useAIText flag
6. If true, builds special prompt using buildPromptWithTextRendering()
7. Modified prompt tells Imagen to render text in image:
   "Background: coffee, with text "COFFEE" rendered cinematic, 
    professional, bold typography, dramatic composition, 
    high contrast, 8K resolution, professional design"
8. Imagen generates 4 images WITH text baked into image
9. Text is artistic (smoke, fire, neon effects depending on style)
10. Text is NON-EDITABLE (part of image)
11. Perfect for social media needing bold typography

Prompt Engineering for Text Rendering:
  buildPromptWithTextRendering(subject, text, useAIText, template, style)
  
  If useAIText = true:
    â†’ Special prompt: "Background: [subject], with text "[text]" rendered [style], 
       bold typography, dramatic composition, high contrast, 8K resolution, 
       professional design"
  
  If useAIText = false:
    â†’ Normal prompt: standard image generation without text

Toggle Location:
  Canvas Sidebar â†’ Tools section
  â˜ Use AI Text Effects?
  âš ï¸ Renders text in image (non-editable)

State Management:
  - useAIText: boolean state in Canvas component
  - toggles with checkbox: onChange={(e) => setUseAIText(e.target.checked)}
  - passed to generateImages() function
  - included in API request body

Code Path (AI Text Mode):
  Toggle ON "Use AI Text Effects?"
    â†“
  Enter prompt "coffee"
    â†“
  Click "ğŸ¨ Generate Image"
    â†“
  generateImages() with useAIText=true
    â†“
  API receives { useAIText: true, aiTextContent: "coffee" }
    â†“
  buildPromptWithTextRendering() creates special prompt
    â†“
  Prompt: "Background: coffee, with text "COFFEE" rendered..."
    â†“
  Imagen-4 generates images WITH text rendered
    â†“
  4 image variants with artistic text appear
    â†“
  User selects image (no auto-headline in this mode)
    â†“
  Image added to canvas as background
    â†“
  Download exports final PNG

Difference vs Normal Mode:
  Normal Mode:         AI Text Effects Mode:
  âœ“ Image generated    âœ“ Image WITH text generated
  âœ“ Text added after   âœ“ Text rendered IN image
  âœ“ Text editable      âœ“ Text non-editable
  âœ“ Full control       âœ“ Artistic effects
  âœ“ For flexibility    âœ“ For social media

Example Use Cases:
  AI Text Effects ON:  Sales graphics, announcements, bold designs
  AI Text Effects OFF: Flexible designs, editable marketing materials

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
COMPLETE MVP LOOP DATA FLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

START: User at http://localhost:3000/editor

STEP 1: BRAND EXTRACTION (existing feature)
  Input: "google.com"
  Process:
    â†’ /api/extract-brand (cheerio web scraping)
    â†’ Returns: { primaryColor, secondaryColor, accentColor, logo }
    â†’ Stored in brandData state
  Output: Brand colors displayed in sidebar

STEP 2: IMAGE GENERATION
  User selects:
    - Prompt: "coffee"
    - Template: "image-text"
    - AI Text Effects: OFF (normal mode)
  
  Process:
    â†’ generateImages() in canvas.tsx
    â†’ POST /api/generateImage
    â†’ Body: {
        prompt: "coffee",
        template: "image-text",
        primaryColor: "#4285F4",
        useAIText: false,
        userId: "user-123"
      }
    â†’ API receives request
    â†’ buildCompletPrompt() creates detailed prompt:
      "coffee, photorealistic, high quality, professional photography,
       leave top 10% empty for text overlay, image occupies 60% height,
       9:11.25 aspect ratio, 8K resolution, ultra high quality"
    â†’ generateImages() in vertex-ai.ts calls Imagen-4
    â†’ Imagen returns 4 base64-encoded images
    â†’ Upload to Supabase Storage
    â†’ Return public URLs
  
  Output: 4 image variants in modal

STEP 3: IMAGE SELECTION (NEW - Smart Image Selection)
  User clicks image #1 in modal
  
  Process:
    â†’ ImageGrid.handleSelect(image) triggered
    â†’ onSelect callback â†’ Canvas.handleImageSelect(image)
    â†’ fabric.js Image created from image data
    â†’ Image scaled to 1080x1350px
    â†’ Image added to canvas with zIndex=0
    â†’ generateAndAddHeadline() called immediately
  
  Parallel Process: Gemini Headline Generation
    â†’ fetch /api/generateHeadline
    â†’ Body: { subject: "coffee" }
    â†’ API calls Gemini with prompt engineering:
      "Generate a single, short marketing headline (5 words max)
       for a design image about "coffee"..."
    â†’ Gemini returns: "Brew Perfection Daily"
    â†’ Response parsed: remove quotes, take first line
    â†’ Textbox created:
      {
        text: "Brew Perfection Daily",
        fill: brandData.primaryColor, // Google Blue
        fontFamily: brandData.fonts[0], // Google Font
        fontSize: 48,
        fontWeight: "bold",
        textAlign: "center",
        stroke: "#000000", // Black outline for visibility
        strokeWidth: 2
      }
    â†’ Textbox added to canvas at (50, 50)
    â†’ Modal closes after 500ms
  
  Output: Canvas shows image + auto-generated text

STEP 4: CANVAS EDITING
  User can:
    - Double-click text to edit it
    - Drag text to reposition it
    - Add more text with "+ Add Text" button
    - Change text color/font in edits
    - Adjust template if needed
  
  Output: Customized design

STEP 5: EXPORT
  User clicks "â¬‡ï¸ Download"
  
  Process:
    â†’ fabricCanvas.toDataURL() converts to PNG
    â†’ Creates data URL as blob
    â†’ Triggers browser download
    â†’ File named: design-[timestamp].png
  
  Output: PNG file downloaded (1080x1350)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
API ENDPOINTS (Updated)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

POST /api/generateImage
  Purpose: Generate 4 image variants using Imagen-4
  
  Request Body:
    {
      prompt: string (required)
      template: "full-image" | "image-text" | "two-column" | "centered"
      primaryColor?: string (hex)
      secondaryColor?: string (hex)
      accentColor?: string (hex)
      userId?: string
      useAIText?: boolean (NEW)
      aiTextContent?: string (NEW)
    }
  
  Response:
    {
      success: boolean
      images: [
        {
          id: string
          url: string (Supabase public URL)
          base64?: string (image data)
          storagePath: string
          createdAt: string
        }
      ]
      prompt: string (final prompt sent to Imagen)
      error?: string
    }

POST /api/generateHeadline (NEW)
  Purpose: Generate marketing headlines with Gemini
  
  Request Body:
    {
      subject: string (required, e.g., "coffee")
    }
  
  Response:
    {
      success: boolean
      headline?: string (5 words max, e.g., "Brew Perfection Daily")
      error?: string
    }
  
  Notes:
    - Called automatically when image selected
    - Optional - design works without it
    - Requires GOOGLE_GENERATIVE_AI_API_KEY in env
    - Falls back gracefully if API key missing

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STATE MANAGEMENT (Canvas Component)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const [selectedTemplate, setSelectedTemplate] = useState<string>('image-text')
  â†’ User's chosen template

const [promptInput, setPromptInput] = useState<string>('')
  â†’ User's image description text

const [useAIText, setUseAIText] = useState(false)
  â†’ NEW: Toggle for AI text effects mode

const [generatingImages, setGeneratingImages] = useState(false)
  â†’ Loading state while Imagen generates

const [generatingHeadline, setGeneratingHeadline] = useState(false)
  â†’ NEW: Loading state while Gemini generates headline

const [generatedImages, setGeneratedImages] = useState<any[]>([])
  â†’ Array of 4 generated images

const [showImageGrid, setShowImageGrid] = useState(false)
  â†’ Modal visibility toggle

const [imagePrompt, setImagePrompt] = useState<string>('')
  â†’ Stores original prompt for display in modal

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DEPENDENCIES (New Package Added)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

@google/generative-ai@0.x.x
  â†’ Used in /api/generateHeadline
  â†’ Calls Gemini 1.5 Flash for headline generation
  â†’ Lightweight alternative to full Google Cloud SDK
  â†’ Requires: GOOGLE_GENERATIVE_AI_API_KEY env variable

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FILES MODIFIED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1. src/components/canvas.tsx (Major Update)
   - Added useAIText state
   - Added generatingHeadline state
   - Rewrote handleImageSelect() to add image background
   - Added generateAndAddHeadline() function
   - Updated generateImages() to pass useAIText
   - Added UI toggle in Tools section
   - Total: +150 lines of code

2. src/components/image-grid.tsx (Minor Update)
   - Modified handleSelect to close modal after 500ms
   - Allows image to start loading before modal closes
   - Total: +3 lines change

3. src/lib/prompt-engineering.ts (Major Update)
   - Added generateHeadlinePrompt()
   - Added generateTextRenderingPrompt()
   - Added buildPromptWithTextRendering()
   - All exported functions for API usage
   - Total: +60 lines of code

4. src/app/api/generateImage/route.ts (Update)
   - Added useAIText and aiTextContent to request interface
   - Updated prompt building logic to handle AI text mode
   - Added conditional routing to buildPromptWithTextRendering
   - Added logging for mode selection
   - Total: +15 lines change

5. src/app/api/generateHeadline/route.ts (NEW FILE)
   - 60 lines of code
   - Implements Gemini headline generation
   - Error handling and fallback
   - Response parsing and cleaning

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

The MVP Loop is now complete and production-ready! ğŸš€
